<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Voz a Texto en Tiempo Real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f4f4f4;
    }
    #texto {
      margin-top: 20px;
      padding: 1rem;
      background: white;
      border: 1px solid #ccc;
      min-height: 100px;
      white-space: pre-wrap;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    #iconoMicrofono {
      font-size: 32px;
      vertical-align: middle;
      margin-left: 10px;
      color: gray;
      transition: color 0.3s ease;
    }
    .activo {
      color: red !important;
    }
  </style>
  <!-- Font Awesome para el √≠cono del micr√≥fono -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <h1>üé§ Voz a Texto (Tiempo Real)</h1>

  <div>
    <button id="btnIniciar">Iniciar</button>
    <button id="btnDetener" disabled>Detener</button>
    <button id="btnLimpiar">Limpiar</button>
    <button id="btnCopiar">Copiar texto</button>
    <button id="btnExportar">Exportar .txt</button>
    <i id="iconoMicrofono" class="fa-solid fa-microphone"></i>
  </div>

  <div id="texto">Texto reconocido aparecer√° aqu√≠...</div>

  <hr>
  <p><strong>Compatibilidad del navegador:</strong> Esta funci√≥n solo est√° soportada en navegadores como:</p>
  <ul>
    <li>üü¢ <strong>Google Chrome</strong> (recomendado ‚úÖ)</li>
    <li>üü¢ <strong>Microsoft Edge Chromium</strong></li>
    <li>üî¥ <strong>No compatible:</strong> Safari, Firefox, Brave, Opera</li>
  </ul>
  <p style="font-size: 0.9rem; color: gray;">
    ‚ö†Ô∏è Nota: Aseg√∫rate de tener activado el micr√≥fono y de otorgar permisos cuando el navegador lo solicite.
  </p>

  <script>
    const btnIniciar = document.getElementById('btnIniciar');
    const btnDetener = document.getElementById('btnDetener');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const btnCopiar = document.getElementById('btnCopiar');
    const btnExportar = document.getElementById('btnExportar');
    const texto = document.getElementById('texto');
    const icono = document.getElementById('iconoMicrofono');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let textoFinal = '';
    let escuchando = false;

    if (!SpeechRecognition) {
      alert('Tu navegador no soporta la Web Speech API. Usa Google Chrome.');
    } else {
      recognition = new SpeechRecognition();
      recognition.lang = 'es-PE';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onstart = () => {
        console.log('Reconocimiento iniciado');
      };

      recognition.onresult = (event) => {
        let textoTemporal = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const resultado = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            textoFinal += resultado + '\n';
          } else {
            textoTemporal += resultado;
          }
        }
        texto.textContent = textoFinal + textoTemporal;
      };

      recognition.onerror = (event) => {
        console.warn('Error:', event.error);
        if (event.error === 'no-speech') {
          console.log('Silencio detectado, reiniciando...');
          recognition.stop(); // se reiniciar√° en onend
        }
      };

      recognition.onend = () => {
        if (escuchando) {
          console.log('Reconocimiento reiniciado');
          recognition.start();
        }
      };

      btnIniciar.onclick = () => {
        navigator.permissions.query({ name: 'microphone' }).then((permiso) => {
          if (permiso.state === 'denied') {
            alert('Debes permitir el uso del micr√≥fono para que funcione.');
            return;
          }

          escuchando = true;
          textoFinal = '';
          recognition.start();
          btnIniciar.disabled = true;
          btnDetener.disabled = false;
          icono.classList.add('activo');
        });
      };

      btnDetener.onclick = () => {
        escuchando = false;
        recognition.stop();
        btnIniciar.disabled = false;
        btnDetener.disabled = true;
        icono.classList.remove('activo');
      };

      btnLimpiar.onclick = () => {
        textoFinal = '';
        texto.textContent = 'Texto reconocido aparecer√° aqu√≠...';
      };

      btnCopiar.onclick = () => {
        navigator.clipboard.writeText(texto.textContent).then(() => {
          alert('Texto copiado al portapapeles.');
        }).catch(() => {
          alert('Error al copiar el texto.');
        });
      };

      btnExportar.onclick = () => {
        const blob = new Blob([texto.textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const enlace = document.createElement('a');
        enlace.href = url;
        enlace.download = 'transcripcion.txt';
        enlace.click();
        URL.revokeObjectURL(url);
      };
    }
  </script>

</body>
</html>
